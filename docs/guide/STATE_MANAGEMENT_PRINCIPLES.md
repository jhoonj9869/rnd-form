# 상태 관리 원칙 및 버그 예방 가이드

> 📅 작성일: 2025-09-23
> 🎯 목적: 계층적 상태 관리로 버그 예방
> ⚠️ 상태: 설계 원칙 문서 (구현 예정)

## 🎯 핵심 원칙: 상위 작업은 하위 상태를 리셋한다

```
양식 전체 작업 실행 → 양식/문서 단위 상태 리셋
        ↓
양식 단위 작업 실행 → 문서 단위 상태 리셋
        ↓
문서 단위 작업 실행 → 현재 문서만 영향
```

---

## 📋 계층별 상태 관리 규칙

### 1️⃣ **문서 단위 작업** (Document Level)

#### 원칙
> 현재 문서(currentDoc)에 강하게 바인딩되어, 문서 전환 시 자동으로 상태도 전환

#### 상태 전환 시나리오
```javascript
// 문서 A → 문서 B 전환 시
1. 문서 A의 상태 저장 (자동)
2. 문서 B 로드
3. 문서 B의 상태로 전체 UI 업데이트
4. 입력 필드, 미리보기, 메타데이터 모두 B로 전환
```

#### 관리되어야 할 상태들
- ✅ currentDoc 객체
- ✅ 입력 필드 값들
- ✅ 저장 상태 (isDocumentSaved)
- ✅ 편집 모드 (isEditable)
- ✅ 첨부파일 목록
- ✅ 유효성 검사 결과

#### 버그 예방 체크리스트
- [ ] 문서 전환 시 이전 문서 상태가 남아있지 않은가?
- [ ] 새 문서 생성 시 이전 문서 데이터가 섞이지 않는가?
- [ ] 문서 ID가 올바르게 전환되는가?

---

### 2️⃣ **양식 단위 작업** (Form Level)

#### 원칙
> 양식 전환 시 진행 중인 문서 작업 중단 및 currentDoc 초기화

#### 상태 전환 시나리오
```javascript
// 양식 A → 양식 B 전환 시
1. 양식 A의 현재 문서 상태 저장 (DocStateManager)
2. 양식 A의 작업 중단
3. currentDoc = null 또는 빈 문서로 초기화
4. 양식 B의 템플릿 로드
5. 양식 B의 마지막 상태 복원 또는 새 문서
```

#### 관리되어야 할 상태들
- ✅ currentFormType
- ✅ 양식별 workspace 문서
- ✅ 양식별 cache 목록
- ✅ 양식 템플릿
- ✅ 양식별 설정 (필드, 검증 규칙)

#### 버그 예방 체크리스트
- [ ] 양식 전환 시 이전 양식의 문서가 표시되지 않는가?
- [ ] 각 양식의 workspace가 독립적으로 유지되는가?
- [ ] 양식별 저장 경로가 올바른가?
- [ ] 템플릿이 올바르게 전환되는가?

#### 현재 구현 상태
```javascript
// DocStateManager가 이미 부분적으로 구현
docStateManager.switchContext(formType, storageType, docId)
// → 양식별 독립 상태 유지 중
```

---

### 3️⃣ **양식 전체 작업** (All Forms Level)

#### 원칙
> 모든 양식 새로고침 시 모든 하위 상태 리셋

#### 상태 전환 시나리오
```javascript
// 전체 새로고침 시
1. 모든 양식의 진행 중인 작업 중단
2. currentDoc = null
3. currentFormType = 기본값
4. 모든 workspace 상태 초기화 (선택적)
5. 모든 템플릿 재로드
6. 설정 파일 재로드
```

#### 관리되어야 할 상태들
- ✅ 전체 양식 목록
- ✅ 양식 레지스트리
- ✅ 공통 템플릿
- ✅ 전역 설정

#### 버그 예방 체크리스트
- [ ] 새로고침 후 이전 상태가 의도치 않게 남아있지 않은가?
- [ ] 모든 양식이 올바르게 재로드되는가?
- [ ] 메모리 누수가 없는가?

---

## 🔄 상태 전환 플로우

### 정상적인 플로우
```
사용자 액션 → 범위 확인 → 상위 상태 리셋 → 작업 실행 → 새 상태 설정
```

### 버그 발생 패턴 (피해야 할 것)
```
❌ 양식 전환 → 이전 문서 유지 → 잘못된 양식에 저장
❌ 문서 전환 → 이전 첨부파일 표시 → 데이터 혼재
❌ 새로고침 → 부분적 리셋 → 일관성 없는 상태
```

---

## 🛠️ 구현 가이드라인

### Phase 1: 현재 상태 분석 (분석만)
```javascript
// 1. 문서 단위 상태 전환 검증
function validateDocumentStateTransition() {
  // currentDoc 전환 시 모든 관련 상태 체크
  // 입력 필드, 첨부파일, 저장 상태 등
}

// 2. 양식 단위 상태 격리 검증
function validateFormIsolation() {
  // 각 양식의 workspace가 독립적인지
  // 양식 전환 시 상태 보존/리셋이 올바른지
}

// 3. 전체 새로고침 완전성 검증
function validateFullRefresh() {
  // 모든 상태가 초기화되는지
  // 메모리 누수가 없는지
}
```

### Phase 2: 상태 관리자 확장 (향후)
```javascript
class HierarchicalStateManager {
  constructor() {
    this.levels = {
      system: {},     // 별도 범위
      allForms: {},   // 양식 전체
      perForm: {},    // 양식 단위
      perDoc: {}      // 문서 단위
    };
  }

  // 상위 레벨 작업 시 하위 리셋
  executeWithReset(level, action) {
    this.resetLowerLevels(level);
    return action();
  }

  resetLowerLevels(level) {
    // 계층에 따라 하위 상태 리셋
    switch(level) {
      case 'allForms':
        this.levels.perForm = {};
        this.levels.perDoc = {};
        break;
      case 'perForm':
        this.levels.perDoc = {};
        break;
    }
  }
}
```

### Phase 3: 통합 테스트 시나리오 (향후)
```javascript
// 테스트 케이스 예시
describe('계층적 상태 관리', () => {
  test('양식 전환 시 문서 상태 리셋', () => {
    // 1. 양식 A에서 문서 작성
    // 2. 양식 B로 전환
    // 3. 양식 A의 문서가 표시되지 않는지 확인
  });

  test('전체 새로고침 시 모든 상태 리셋', () => {
    // 1. 여러 양식에서 작업
    // 2. 전체 새로고침
    // 3. 모든 상태가 초기값인지 확인
  });
});
```

---

## 🐛 알려진 버그 패턴과 해결책

### 1. "유령 문서" 버그
**증상**: 양식 전환 후 이전 양식의 문서가 보임
**원인**: currentDoc이 리셋되지 않음
**해결**: 양식 전환 시 currentDoc = null 명시적 설정

### 2. "데이터 오염" 버그
**증상**: 새 문서에 이전 문서 데이터가 포함
**원인**: 객체 참조 공유
**해결**: 깊은 복사 또는 새 객체 생성

### 3. "저장 경로 혼동" 버그
**증상**: A 양식 문서가 B 양식 폴더에 저장
**원인**: currentFormType 동기화 실패
**해결**: 저장 시점의 formType 명시적 전달

---

## 📊 상태 관리 매트릭스

| 작업 범위 | 리셋 대상 | 보존 대상 | 위험도 |
|-----------|-----------|-----------|--------|
| 문서 단위 | 없음 | 모든 상위 상태 | 낮음 |
| 양식 단위 | 문서 상태 | 다른 양식 상태 | 중간 |
| 양식 전체 | 모든 하위 상태 | 시스템 설정 | 높음 |
| 시스템 | 모든 상태 | 없음 | 매우 높음 |

---

## ✅ 구현 우선순위

1. **즉시 필요** (현재 버그 해결)
   - 양식 전환 시 currentDoc 리셋
   - 문서 전환 시 상태 완전 교체

2. **단기 개선** (v2.5.0)
   - HierarchicalStateManager 구현
   - 자동 상태 검증 시스템

3. **장기 목표** (v3.0.0)
   - 상태 변경 이력 추적
   - 상태 롤백 기능
   - 상태 디버거 도구

---

## 💡 핵심 교훈

> **"상위 작업은 하위 상태를 리셋한다"**
>
> 이 원칙만 지켜도 대부분의 상태 관련 버그를 예방할 수 있습니다.

### 개발자 체크리스트
- [ ] 새 기능 추가 시 어느 범위인지 먼저 결정
- [ ] 상위 범위 작업이면 하위 리셋 코드 추가
- [ ] 상태 전환 테스트 케이스 작성
- [ ] 메모리 누수 확인

---

## 📚 참고 자료

- [UI 및 기능 계층 구조](./UI_FUNCTION_HIERARCHY.md)
- [JavaScript 모듈 가이드](./JS_MODULES_GUIDE.md)
- [DocStateManager 구현](../src/js/doc-state-manager.js)